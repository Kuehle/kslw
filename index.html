<!DOCTYPE html>
<html lang="en">

<head>
    <title></title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="css2.css" rel="stylesheet">
</head>

<body>
    <div class="overlay"></div>
    <!--<div class="picked-map-overlay"></div>-->
    <div class="map-voting">
        <!-- maps generated by js -->
    </div>
    <div class="map-submit">
        <button onclick="generateSlotMachine()">Give me Map</button>
        <button onclick="createAll()">Clear All</button>
    </div>
</body>
<script>
  let enableSlotMachine = false

  // TODO mouse over - show name
    var mapList = [
        "Luigis Piste",
        "Peach Beach",
        "Baby Park",
        "Staubtrockene Piste",
        "PilzbrÃ¼cke",
        "Marios Piste",
        "Daisys Dampfer",
        "Waluigi Arena",
        "Sorbet Land",
        "Pilz-City",
        "Yoshis Piste",
        "DK Bergland",
        "Wario Colosseum",
        "Dinodino-Dschungel",
        "Bowsers Festung",
        "Regenbogen-Boulevard"
    ];

    var pickedList = []
    var mapToCome

    window.onload = createAll

    function createAll() {
        pickedList = []
       let mapVotingEl = document.querySelector('.map-voting')
        deleteAllChildren(mapVotingEl)
        mapList.forEach(function(map, i) {
            mapVotingEl.appendChild(createMapButtonElement(map, i))
        })
    }

    function createMapButtonElement(map, i) {
        let el = document.createElement('div')
        el.classList.add('map')
        el.dataset.id = i
        el.dataset.name = mapList[i]
        el.dataset.state = 0
        el.style.backgroundImage = `url(img/${i+1}.jpg)`
        el.addEventListener('click', toggleState)
        return el
    }

    function toggleState(ev) {
        ev.target.dataset.state = (ev.target.dataset.state+1) % 3
        if(ev.target.dataset.state == 1) {
            ev.target.classList.add('ban')
        } else if (ev.target.dataset.state == 2) {
            ev.target.classList.remove('ban')
            ev.target.classList.add('pick')
            pickedList.push(ev.target.dataset.id)
        } else {
            ev.target.classList.remove('pick')
            pickedList.splice(pickedList.indexOf(ev.target.dataset.id),1)
        }
    }

    function giveMeMap() {
        console.log(pickedList)
        if(pickedList.length) {
            let rng = Math.floor(Math.random()*pickedList.length)
            return pickedList[rng]
        }      
    }

    function toggleUi(state = false, time = 3000) {
        let uiBlocker = document.querySelector('.disable-ui')
        if(state) {
            uiBlocker.style.display = 'none'
        } else {
            uiBlocker.style.display = 'block'
            setTimeout(() => toggleUi(true), time)
        }
    }

    function deletePickedMap() {
        // document.querySelector('.picked-map-overlay').innerHTML = ''
        document.documentElement.removeEventListener('click', deletePickedMap)
    }

  function generateSlotMachine() {
      enableSlotMachine = true
        if(!pickedList.length) {
            mapList.forEach((val, ind) => {
                pickedList.push(ind+1)
            })
            pickedList.forEach((val, ind) => console.log(document.querySelector('.map-voting').childNodes[ind].dataset.state))
        }
        document.querySelector('.overlay').innerHTML = `
            <div class="rng-container"  onclick="runSlotMachine()">
                <div class="arrow"></div>
                <div class="map-slotmachine"></div>
            </div>    
            `
        document.querySelector('.rng-container').style.display = 'block'
        let slotMachine = document.querySelector('.map-slotmachine')
        deleteAllChildren(slotMachine)
        slotMachine.style.transition = 'none'
        slotMachine.style.left = 0
        mapToCome = giveMeMap()
        let rngArr = []
        for(let i = 0; i < 50; i++) {
            rngArr.push(pickedList[Math.floor(Math.random()*pickedList.length)])
        }
        rngArr[40] = mapToCome
        console.log(rngArr)
        while(slotMachine.childElementCount) {
            slotMachine.remove(slotMachine.firstChild)
        }
        for(let i = 0; i < 50; i++) {
            let el = document.createElement('div')
            el.classList.add('map-slot')
            el.style.backgroundImage = `url(img/${Number(rngArr[i])+1}.jpg)`
            el.style.backgroundSize = 'cover'
            slotMachine.appendChild(el)
        }
    }

    function deleteAllChildren(el) {
        while(el.firstChild) {
            el.removeChild(el.firstChild)
        }
    }

  function runSlotMachine(delay = 16000) {
      if (enableSlotMachine) {
        let slotMachine = document.querySelector('.map-slotmachine')
        slotMachine.style.transition = `${delay/1000}s cubic-bezier(0.0, 0, 0.000, 1)`
        slotMachine.style.left = `-${15180 + Math.random()*400}px`
          setTimeout(() => announcePick(mapToCome), delay)
          enableSlotMachine = false
      } else {
          
          document.querySelector('.overlay').innerHTML = "" 
      }
    }

    function announcePick(id) {
        // document.querySelector('.picked-map-overlay').innerHTML = mapList[id]         
    }
</script>

</html>
